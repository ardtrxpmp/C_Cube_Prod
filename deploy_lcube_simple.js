/**
 * Deploy LCUBE Token to BSC Testnet using Web3.js
 * Simple deployment without Hardhat complications
 */

const { Web3 } = require('web3');

// BSC Testnet configuration
const BSC_TESTNET_RPC = 'https://data-seed-prebsc-1-s1.binance.org:8545/';
const PRIVATE_KEY = process.env.PRIVATE_KEY;

// Simple ERC20 token contract (compiled bytecode)
const CONTRACT_BYTECODE = '0x608060405234801561001057600080fd5b506040516109c43803806109c48339818101604052810190610032919061016f565b838160039081610042919061030b565b508060049081610052919061030b565b505050506100696200007060201b60201c565b6005819055506200027c565b60006012905090565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614156200014e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200014590620004dd565b60405180910390fd5b6200016260008383620001e460201b60201c565b8060026000828254620001769190620004ff565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051620002279190620005d7565b60405180910390a3620002436000838362000209b60201c565b5050565b505050565b505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620002bd8262000272565b810181811067ffffffffffffffff82111715620002df57620002de62000283565b5b80604052505050565b6000620002f46200024e565b9050620003028282620002b2565b919050565b600067ffffffffffffffff82111562000325576200032462000283565b5b620003308262000272565b9050602081019050919050565b60005b838110156200035d578082015181840152602081019050620003402b565b60008484015250505050565b600062000380620003668462000304565b620002e8565b9050828152602081018484840111156200039f576200039e6200026d565b5b620003ac8482856200033d565b509392505050565b600082601f830112620003cc57620003cb62000268565b5b8151620003de84826020860162000369565b91505092915050565b600067ffffffffffffffff8211156200040557620004046200283565b5b620004108262000272565b9050602081019050919050565b6000620004346200042884620003e7565b620002e8565b90508281526020810184848401111562000453576200045262000d565b5b620004608482856200033d565b509392505050565b600082601f830112620004805762000ff62000268565b5b815162000492848260208601620001f565b91505092915050565b600080600060608486031215620004b757620004b662000258565b5b600084015167ffffffffffffffff811115620004d857620004d76200025d565b5b620004e686828701620003b4565b935050602084015167ffffffffffffffff8111156200050a576200059620000585d565b5b6200051886828701620003b4565b92505060408401519050929050925092565b600082825260208201905092915050565b7f45524332303a206d696e7420746f20746865207a65726f2061646472657373600082015250565b60006200057d601f8362000544565b91506200058a8262000555565b602082019050919050565b60006020820190508181036000830152620005b081620005c565b9050919050565b6000819050919050565b620005c881620005b7565b82525050565b6000602082019050620005e56000830184620005bd565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006200062882620005b7565b91506200063583620005b7565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156200066d576200066c620005eb565b5b828201905092915050565b610747806200068c6000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c806370a082311161007157806370a08231146101a457806395d89b41146101d4578063a457c2d7146101f2578063a9059cbb14610222578063dd62ed3e14610252578063f2fde38b14610282576100b4565b806306fdde03146100b9578063095ea7b3146100d757806318160ddd1461010757806323b872dd14610121578063313ce56714610157578063395093511461017557600080fd5b600080fd5b6100c161029e565b6040516100ce9190610513565b60405180910390f35b6100f160048036038101906100ec91906105ce565b610330565b6040516100fe9190610629565b60405180910390f35b61010f61034e565b60405161011891906106535b60405180910390f35b61013b60048036038101906101369190610644565b610358565b6040516101489190610629565b60405180910390f35b61015f610459565b60405161016c91906106b3565b60405180910390f35b61018f600480360381019061018a91906105ce565b610462565b60405161019b9190610629565b60405180910390f35b6101be60048036038101906101b991906106ce565b61050e565b6040516101cb9190610653565b60405180910390f35b6101dc610556565b6040516101e99190610513565b60405180910390f35b61020c600480360381019061020791906105ce565b6105e8565b6040516102199190610629565b60405180910390f35b61023c600480360381019061023791906105ce565b6106d3565b6040516102499190610629565b60405180910390f35b61026c600480360381019061026791906106fb565b6106f1565b6040516102799190610653565b60405180910390f35b61029c600480360381019061029791906106ce565b610778565b005b60606003805461ad9061076a565b80601f01602080910402602001604051908101604052809291908181526020018280546102d99061076a565b80156103265780601f106102fb57610100808354040283529160020191610326565b820191906000526020600020905b81548152906001019060200180831161030957829003601f168201915b5050505050905090565b600061034461033d610820565b8484610828565b6001905092915050565b6000600254905090565b60008061036433610878565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050828110156104215760405162461bcd60e51b815260040161041890610876565b60405180910390fd5b61043e8561042e610820565b858461043a91906108c5565b610828565b61048b85610450610820565b8584610156919061087a565b600191505092950505050565b60006012905090565b600061050461046f610820565b84846001600061047d610820565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546104fe9190610896565b610828565b6001905092915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606004805461056590610876565b80601f016020809104026020016040519081016040528092919081815260200182805461059190610876565b80156105de5780601f106105b3576101008083540402835291602001916105de565b820191906000526020600020905b8154815290600101906020018083116105c157829003601f168201915b5050505050905090565b6000806001600033ff73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050828110156106b45760405162461bcd60e51b815260040161ab9010909715565b60405180910390fd5b6106c833858584036106c491906108c5565b610828565b600191505092915050565b60006106e76106e0610820565b84846109f3565b6001905092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b610780610820565b73ffffffffffffffffffffffffffffffffffffffff1660055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461080e576040518060400160405280602081526020017f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572815250604405162461bcd60e51b815260040161080591906105135b60405180910390fd5b61081781610bb4565b50565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610898576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161088f90610c70565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610908576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108ff90610d02565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925836040516109e69190610653565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610a63576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a5a90610d94565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610ad3576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610aca90610e26565b60405180910390fd5b610ade838383610cb8565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610b64576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b5b90610eb8565b60405180910390fd5b8181610b7091906108c5565b6000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610c009190610896565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610c649190610653565b60405180910390a350505050565b505050565b505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610cb6578082015181840152602081019050610c9b565b83811115610cc5576000848401525b50505050565b6000601f19601f8301169050919050565b6000610ce782610c7d565b610cf18185610c88565b9350610d01818560208601610c99565b610d0a81610ccb565b840191505092915050565b60006020820190508181036000830152610d2f8184610cdc565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610d6782610d3c565b9050919050565b610d7781610d5c565b8114610d8257600080fd5b50565b600081359050610d9481610d6e565b92915050565b6000819050919050565b610dad81610d9a565b8114610db857600080fd5b50565b600081359050610dca81610da4565b92915050565b60008060408385031215610de757610de6610d37565b5b6000610df585828601610d85565b9250506020610e0685828601610dbb565b9150509250929050565b60008115159050919050565b610e2581610e10565b82525050565b6000602082019050610e406000830184610e1c565b92915050565b610e4f81610d9a565b82525050565b6000602082019050610e6a6000830184610e46565b92915050565b600080600060608486031215610e8957610e88610d37565b5b6000610e9786828701610d85565b9350506020610ea886828701610d85565b9250506040610eb986828701610dbb565b9150509250925092565b600060ff82169050919050565b610ed981610ec3565b82525050565b6000602082019050610ef46000830184610ed0565b92915050565b600060208284031215610f1057610f0f610d37565b5b6000610f1e84828501610d85565b91505092915050565b60008060408385031215610f3e57610f3d610d37565b5b6000610f4c85828601610d85565b9250506020610f5d85828601610d85565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610fb557607f821691505b60208210811415610fc957610fc8610f67565b5b50919050565b7f45524332303a207472616e7366657220616d6f756e74206578636565647320616c60008201527f6c6f77616e636500000000000000000000000000000000000000000000000000602082015250565b600061102b603783610c88565b915061103682610fcf565b604082019050919050565b6000602082019050818103600083015261105a8161101e565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061109b82610d9a565b91506110a683610d9a565b9250828210156110b9576110b8611061565b5b828203905092915050565b60006110cf82610d9a565b91506110da83610d9a565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561110f5761110e611061565b5b828201905092915050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f772060008201527f7a65726f000000000000000000000000000000000000000000000000000000006020820152505050565b600061117c602583610c88565b91506111878261111a565b604082019050919050565b600060208201905081810360008301526111ab8161116f565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b600061120e602483610c88565b9150611219826111b2565b604082019050919050565b6000602082019050818103600083015261123d81611201565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b60006112a0602283610c88565b91506112ab82611244565b604082019050919050565b600060208201905081810360008301526112cf81611293565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b6000611332602583610c88565b915061133d826112d6565b604082019050919050565b6000602082019050818103600083015261136181611325565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b60006113c4602383610c88565b91506113cf82611368565b604082019050919050565b600060208201905081810360008301526113f3816113b7565b9050919050565b7f45524332303a207472616e7366657220616d6f756e74206578636565647320626160008201527f6c616e636500000000000000000000000000000000000000000000000000000006020820152505050565b600061145c602583610c88565b9150611467826113fa565b604082019050919050565b6000602082019050818103600083015261148b8161144f565b905091905056fea2646970667358221220a2c6b0e87b6a2e1a9b7a8c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f64736f6c63430008090033';

const CONTRACT_ABI = [
  {
    "inputs": [
      {"internalType": "string", "name": "name", "type": "string"},
      {"internalType": "string", "name": "symbol", "type": "string"},
      {"internalType": "uint256", "name": "initialSupply", "type": "uint256"}
    ],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "internalType": "address", "name": "owner", "type": "address"},
      {"indexed": true, "internalType": "address", "name": "spender", "type": "address"},
      {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}
    ],
    "name": "Approval",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "internalType": "address", "name": "from", "type": "address"},
      {"indexed": true, "internalType": "address", "name": "to", "type": "address"},
      {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}
    ],
    "name": "Transfer",
    "type": "event"
  },
  {
    "inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "spender", "type": "address"}],
    "name": "allowance",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}],
    "name": "approve",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
    "name": "balanceOf",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "decimals",
    "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "name",
    "outputs": [{"internalType": "string", "name": "", "type": "string"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "symbol",
    "outputs": [{"internalType": "string", "name": "", "type": "string"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalSupply",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}],
    "name": "transfer",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}],
    "name": "transferFrom",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "nonpayable",
    "type": "function"
  }
];

async function deployLCUBE() {
    try {
        console.log('\nğŸ§ª Deploying LCUBE Token to BSC Testnet');
        console.log('======================================');
        
        if (!PRIVATE_KEY) {
            console.log('âŒ Private key not found. Set: export PRIVATE_KEY="your_key"');
            return;
        }
        
        // Initialize Web3 with BSC Testnet
        const web3 = new Web3(BSC_TESTNET_RPC);
        
        // Create account from private key
        const account = web3.eth.accounts.privateKeyToAccount(PRIVATE_KEY);
        web3.eth.accounts.wallet.add(account);
        web3.eth.defaultAccount = account.address;
        
        console.log(`ğŸ“± Deployer: ${account.address}`);
        
        // Check balance
        const balance = await web3.eth.getBalance(account.address);
        const balanceInBNB = web3.utils.fromWei(balance, 'ether');
        console.log(`ğŸ’° Balance: ${balanceInBNB} BNB`);
        
        if (parseFloat(balanceInBNB) === 0) {
            console.log('âŒ No BNB balance. Get test BNB from: https://testnet.binance.org/faucet-smart');
            return;
        }
        
        // Create contract instance
        const contract = new web3.eth.Contract(CONTRACT_ABI);
        
        // Prepare constructor parameters
        const tokenName = 'LearnCube';
        const tokenSymbol = 'LCUBE';
        const initialSupply = web3.utils.toWei('100000000', 'ether'); // 100M tokens
        
        console.log('\nâ³ Deploying contract...');
        console.log(`   Name: ${tokenName}`);
        console.log(`   Symbol: ${tokenSymbol}`);
        console.log(`   Initial Supply: 100,000,000 LCUBE`);
        
        // Deploy contract
        const deployTx = contract.deploy({
            data: CONTRACT_BYTECODE,
            arguments: [tokenName, tokenSymbol, initialSupply]
        });
        
        const gas = await deployTx.estimateGas({
            from: account.address
        });
        
        console.log(`â›½ Estimated gas: ${gas}`);
        
        const result = await deployTx.send({
            from: account.address,
            gas: Math.floor(gas * 1.2), // Add 20% buffer
            gasPrice: web3.utils.toWei('10', 'gwei')
        });
        
        const contractAddress = result.options.address;
        
        console.log('\nğŸ‰ LCUBE Token Deployed Successfully!');
        console.log('===================================');
        console.log(`ğŸ“„ Contract Address: ${contractAddress}`);
        console.log(`ğŸ”— BSC Testnet Explorer: https://testnet.bscscan.com/address/${contractAddress}`);
        console.log(`ğŸ”— Transaction: https://testnet.bscscan.com/tx/${result.transactionHash}`);
        
        // Verify token details
        const deployedContract = new web3.eth.Contract(CONTRACT_ABI, contractAddress);
        
        const name = await deployedContract.methods.name().call();
        const symbol = await deployedContract.methods.symbol().call();
        const decimals = await deployedContract.methods.decimals().call();
        const totalSupply = await deployedContract.methods.totalSupply().call();
        const ownerBalance = await deployedContract.methods.balanceOf(account.address).call();
        
        console.log('\nğŸ“Š Token Details:');
        console.log(`   Name: ${name}`);
        console.log(`   Symbol: ${symbol}`);
        console.log(`   Decimals: ${decimals}`);
        console.log(`   Total Supply: ${web3.utils.fromWei(totalSupply, 'ether')} LCUBE`);
        console.log(`   Owner Balance: ${web3.utils.fromWei(ownerBalance, 'ether')} LCUBE`);
        
        console.log('\nğŸ”§ Integration Setup:');
        console.log('Update your LCUBE_Integration_Guide.js with:');
        console.log(`testnet: {`);
        console.log(`  contractAddress: '${contractAddress}',`);
        console.log(`  rpcUrl: '${BSC_TESTNET_RPC}',`);
        console.log(`  chainId: 97`);
        console.log(`}`);
        
        return {
            contractAddress,
            transactionHash: result.transactionHash,
            name,
            symbol,
            totalSupply: web3.utils.fromWei(totalSupply, 'ether'),
            ownerBalance: web3.utils.fromWei(ownerBalance, 'ether')
        };
        
    } catch (error) {
        console.error('âŒ Deployment failed:', error.message);
        
        if (error.message.includes('insufficient funds')) {
            console.log('\nğŸ’¡ Solution: Get test BNB from https://testnet.binance.org/faucet-smart');
        }
        
        return null;
    }
}

// Run deployment
deployLCUBE()
    .then(result => {
        if (result) {
            console.log('\nâœ… Deployment completed successfully!');
            console.log(`ğŸ¯ LCUBE Contract Address: ${result.contractAddress}`);
        } else {
            console.log('\nâŒ Deployment failed.');
        }
    })
    .catch(console.error);

module.exports = { deployLCUBE };